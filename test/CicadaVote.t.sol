pragma solidity ^0.8;

import 'forge-std/Test.sol';
import '../src/CicadaVote.sol';
import '../src/LibUint1024.sol';


contract VoteWrapper is CicadaVote {
    function createVote(
        CicadaVote.PublicParameters memory pp,
        string memory description,
        uint64 startTime,
        uint64 votingPeriod
    )
        external
    {
        _createVote(pp, description, startTime, votingPeriod);
    }

    function castBallot(
        uint256 voteId,
        CicadaVote.PublicParameters memory pp,
        CicadaVote.Puzzle memory ballot,
        CicadaVote.ProofOfValidity memory PoV
    )
        external
    {
        _castBallot(voteId, pp, ballot, PoV);
    }

    function finalizeVote(
        uint256 voteId,
        CicadaVote.PublicParameters memory pp,
        uint64 tallyPlaintext,
        uint256[4] memory w,
        CicadaVote.ProofOfExponentiation memory PoE
    )
        external
    {
        _finalizeVote(voteId, pp, tallyPlaintext, w, PoE);
    }
}

contract CicadaVoteTest is Test {
    using LibUint1024 for *;

    VoteWrapper vote;

    function setUp() external {
        vote = new VoteWrapper();
        vote.createVote(_getPublicParameters(), "test", 0, 5 days);
    }

    function testEndToEnd()
        external
    {
        CicadaVote.PublicParameters memory pp = _getPublicParameters();

        CicadaVote.Puzzle memory Z;
        Z.u = [
            5700081174299932681074366895346476174664566142409724263460709345683317739721,
            15604509745864751380609453460905733184391570040193513370972523270305838250437,
            87574774294926226692112610316220240066654915648764666778264439245555495237598,
            51915959239799143157952236345663519618838273622349253110935793271128320414655
        ];
        Z.v = [
            22741762322445542624003829811537985414578062037761168224287243464035159167427,
            69006410614420446925730906810209063966280954617510895964504072200306839488095,
            99258554122204277707641497627589125070652214684382126694270287702770304319278,
            70435993318348499880777985289127683872848928786575090690665743349256138171680
        ];

        CicadaVote.ProofOfValidity memory PoV;
        PoV.a_0 = [
            14411143447429361719239018362364169709449173979248039936708616362552476533220,
            46020205016531978614488092068880029307639733849976011224145918040608816044726,
            105023144685239362864322626233883053194467628215438616734628201017374292576703,
            27092364898847683710820158486003092414609706401609223234156490297945517754651
        ];
        PoV.b_0 = [
            27844172957191554360622586146255850219810300263859300445796759334396703443048,
            100542585176957561947365413484375047779541102678812180346223671466790537690697,
            35349636469111410740357332949154621110615341620260128893121736650155160634441,
            17462698166862930822542588206235417102709658262403312767833648784397598338624
        ];
        PoV.t_0 = [
            0,
            0,
            19539524660348186605579332705159243076182715917836970009848118943662503682796,
            25118136732702453099365690229958158480806311882602980864282624348866729251563
        ];
        PoV.c_0 = 41915438855630800731578219801316496372852911192344916372001794642484993473201;

        PoV.a_1 = [
            21993526767814876443402750323267396961703436628026446286552397675267061898051,
            101835751235523454944218924906000852126091826873345871895233986214654988334591,
            4326031749827542967480613713809030007160889888926509072218652888317051562473,
            50426365832274649008677703967628265484067590931574639756350611593123803857000
        ];
        PoV.b_1 = [
            3084520901719041791692272784716354755068754619513386605154173595246421998681,
            79196796790269707095498550218558922738690085501301830345427783083025093999252,
            81466958838610548044614768129123502023129523202348121982772859870017836987379,
            24313562031099792731409436132629609276393073316781078909506454553432475744689
        ];
        PoV.t_1 = [
            0,
            0,
            16319555736816182497579846232432726049125348738114813762464970212240466681226,
            52296887107139301183576366186584247667920943686762691460953957160044220280267
        ];
        PoV.c_1 = 35008085023977661658086259598686709899559830229097506815407480733507380647935;

        // s=0 ballot
        vote.castBallot(1, pp, Z, PoV);

        Z.u = [
            22272625393663638706142128444419700012944976418741496555702634780451089938756,
            92028026361939007447959780790958821173082703594363762912957890114124643962703,
            48369374811923677590246767048481941244368029363680600668382022820914646922989,
            60638351912413637487339933668766109271543881734949961231018713118393129175123
        ];
        Z.v = [
            29827174676860509820308027920023355423792102309202968001448849449822052133659,
            113267075685142735887145214758802332460452032648558779349308229612904706570794,
            40158273124912196410307419372392711662031468086544684107190993834399063677253,
            86066778871548417356039162287322936818329060167295790076558075875966853271703
        ];

        PoV.a_0 = [
            1470204032603364858058213522131375085456050227602422185516308487924551689750,
            101149631474188438923757374805929364772740544596992504261384494601333660935588,
            86579117109321443986849264750786885827146513006190388823742228166101521952703,
            57636555201240138439848346731341116438480102253024039348412357725744193541957
        ];
        PoV.b_0 = [
            10172630148862551508055985680039508258542318001019417216495257617457603626241,
            17036705248819893862243959317439546835158446858607036531940659373067942626113,
            37662928559800380906955841583180682414721689267861686379065674169028292284087,
            70722754033473102782174247645925250284018779647883853172000235488914921211461
        ];
        PoV.t_0 = [
            0,
            0,
            19866375298381909742255450152341386460660351188226512144967721388270823740276,
            47988849716575919021509826116810269245908534257758739096744639066643010704732
        ];
        PoV.c_0 = 72473905187247928594249110759522698859466541896251160292394254962769318132101;

        PoV.a_1 = [
            27420442198266139006968794351989240559865186775400472728954786134822538162408,
            96625666022632919484972936383675458438452120869033417690083555468164760057376,
            1077532766805505664928461442036718736444246996188724186027288661518556402172,
            112955630628384478384862060904717792269610108823213186718238466235522602978111
        ];
        PoV.b_1 = [
            14648299954855804369529448693610665805438416711222365687364177635565994446754,
            95411310419276590011382273132698795365851768725199174597318393280110607137796,
            35152054689184886692423023548873534324634810190748688928289411767784637491492,
            109049350758229982244725283628829122667387352127932183852210917161364953615466
        ];
        PoV.t_1 = [
            0,
            0,
            29441818245649309955377587314631094476881520018606255773319565580198632262343,
            46718338862534477701269846525067415662028036897081689519808253366687483845523
        ];
        PoV.c_1 = 107405780472151176997810453846808786167911155706368471090843457608163191628941;

        // s=1 ballot
        vote.castBallot(1, pp, Z, PoV);

        Z.u = [
            14905730911579614008755041529955934820229669972229237251636247922146237580825,
            35128189744123870389436735275661327190990607946232235460322276639841625041943,
            65320937463488008933728854228135192008427315893492303361081541574994024806585,
            39547689463024092271377878970259545529468309787739892597292827136143170629856
        ];
        Z.v = [
            28615969209999364517790571012153571174416107367366111245400048901659266052484,
            23804265647581919735940086673666857153198391385312499719787597778059142885153,
            43030860536116660770236202190950919023609617413563115047668840583368040738042,
            77802921143736150172574482748097700196155576207184381170008738974822328198814
        ];

        PoV.a_0 = [
            4018908953301428528487116765216246827953618087078788377064436732063499233635,
            54287142734034519502092122610583514757111267576210921518352485763518986966247,
            6171180486057780470670785332422352555692155866954858502701848401435012084280,
            66175214391789267296445539116381530983103774835260760599058460146830668433503
        ];
        PoV.b_0 = [
            7294530344187438996314349182445053614613773686948355518103539813975572507869,
            41580536191933071435176112910795204471770827134167331591854691579742969163488,
            2358946638781935781097297281992033728532167956874673416567201911008996748385,
            97569573187759877843545512848038993013192403081001970242259998772722313891037
        ];
        PoV.t_0 = [
            0,
            0,
            31795470620660650600517922620126419096321959304813453512797041283052784825326,
            83343025005852819054826517422652344188681594306052651799745168111754956861434
        ];
        PoV.c_0 = 110059977310555860574361541079658408323410730465459960218751464860736573117042;

        PoV.a_1 = [
            18164416754269538382813927964819683787844000617872472829323827294691264772909,
            69328115663982120148342176634671655270384250915491546373106499150521995758334,
            24592573451053712446798918726376018113575702573227341060413387360213757544948,
            6438636505281891281048786814376922092832746754666696371173479505040793823340
        ];
        PoV.b_1 = [
            25208237636284933130031684284804539740222823658176048332348532059211391499837,
            55860372154372219817677614500897710098387893901891908898960072156547236622588,
            4168250915586379435466284479599031738170357446853880371190879499438106162201,
            46003226419792739864739294660668914187089113209180361260854102123946639663797
        ];
        PoV.t_1 = [
            0,
            0,
            6083556622164334913756148115169735909270766176156929527409774009347746403103,
            34935917018848099234879559342423488693837754552005645471523459633954342446971
        ];
        PoV.c_1 = 21058222782455434699595910873772292623889078943646110076584585070352123966223;

        // s=1 ballot
        vote.castBallot(1, pp, Z, PoV);

        Z.u = [
            17131295764576027965255876224135329520724436029709949131960220779127279244747,
            71171050884454772101175899358274106360354456520791683221848587467941937489385,
            69782773021791500886158950412802115349831476226199430296474274122260810843154,
            5585144180909211273003658226989502087423859712045298802400449751878831085080
        ];
        Z.v = [
            8724854672121109412363612968979985661332830535911662105437016624029372080272,
            41179763445391131330275638017830223065994048431928080576733646690885763196440,
            4769290152996961203918952694577814325528960380175761198449425806542859645624,
            89118551076148691654343929562418580515412143368234588630429193998110736238507
        ];

        PoV.a_0 = [
            26981628544049721432044322200586569993683899882453594738751560045746121862664,
            98506126809121093768027632255236395609536392045862276508724524555099782699533,
            6369805738401204605808400164098969057554346872231110718026720007877515787376,
            15989897127314504411634932360005951208941499745473692736167094902996024923189
        ];
        PoV.b_0 = [
            14563839667155724997147948834656954483244109784702523818675151027390894390702,
            111662693066134010213970835001536815449788711785895129855922391975223258240559,
            90105245371647912497208755931928972579881193749882759580193247632569039284978,
            2029086504142866939559653773022950533867116338613877654387064107959814428673
        ];
        PoV.t_0 = [
            0,
            0,
            58099668905103033414612282376564575461314393891420462828798845026592941717344,
            34850173116642625000350025180284266241732451961201076241032215699454165171487
        ];
        PoV.c_0 = 113449408908754105610334436769115911819491989691303120284981031444457963615947;

        PoV.a_1 = [
            27540965199738139542336597499064229104185823022695594461032131781505946148086,
            105981919105693900798204576315126541510834675392352718130006762627365181029491,
            109185282458829238845049511780323628631695517714730429548395368088002109523793,
            25510494567754173011649491066718624482926855531947505998177599239940435862713
        ];
        PoV.b_1 = [
            29340328269404254728576961587800860239779116507468030549065532981227521353106,
            76436558731476918426229264489603798047594460538120472207858901807710994865465,
            104896953808846572790062351795509730042569776709859203850510372511011890192066,
            104436593849047555178156332688360583994743192674888731359384585901804635297228
        ];
        PoV.t_1 = [
            0,
            0,
            23378284162056599081484403218788382272840120908014584360884992940096734170456,
            70454870287284853518870908993888947487360134302965187654640242454815064070660
        ];
        PoV.c_1 = 45650045335340202531807100434175330774304000483989514135739591878971668622562;

        // s=0 ballot
        vote.castBallot(1, pp, Z, PoV);
        
        Z.u = [
            12276599849806108684582815063015487396073672311267662494346481032371757321056,
            3602493552536988030974882089873851948628527241167043316373510039556458506799,
            109967708495461165997320322025495126328571703871089180788028717309625644065731,
            77629497307573924109298924295067707575475326123463608902822675384058464077709
        ];
        Z.v = [
            11698210203278166658234959419615952252153596380886831695505905941962002828789,
            39185435774861639339513106449465358415926699508116783383085263719351255390153,
            109038248331086989542004785127809057576315348032580264823877669083821696847413,
            18869205710622519794824116519260607536660813802614726746278455977076231577921
        ];

        PoV.a_0 = [
            5155249692670676120548130608481437717500313762870617648043357873424037631530,
            109139152891197847909674532702427323897064520048097849647713265350022161113154,
            103425933781608969492599224680944339341738805808585340811237370116019177994836,
            15286949509483346290370347101878925976208194044380939487382947667556631275315
        ];
        PoV.b_0 = [
            1698021363028540173656358912863552973039168424417205332590899586714100661594,
            23271042645722876623029685322839074739669120331640180179074374682376702350110,
            17119212616027145711548207854628375459271179788863430325349915908695980043105,
            62258543223585717783867120981279688666950801679723520417086174004247633989390
        ];
        PoV.t_0 = [
            0,
            0,
            16899635041278795217316771832290450968072698958598233071373548621737250793741,
            8301293942474597517366059383440597932710970994295460008771732573774402751320
        ];
        PoV.c_0 = 76806857864984842039508117816339972297713307419689780926025122773862913923668;

        PoV.a_1 = [
            37336314567602729689780944689599883395462248805644713712914880543243800803154,
            55861220159048614321000360669394080281219957533977922276475561611596479793010,
            25885442158519719236581867925608471241906432932060081031238257085303132923524,
            11920992490575055414614907041940098352152906213815576276597818935543382002675
        ];
        PoV.b_1 = [
            30263583925229104093618420556988098927590280314879190960355275410461986386761,
            14739068747428453111277970124851365151956422727677283720174670300885175450868,
            70284912151522242422660606612654064813295057819747742225709200337153250833884,
            410433651268517073136420373657782878647127207323798796929772899675700772946
        ];
        PoV.t_1 = [
            0,
            0,
            16144596504048607319053995560566649858774262165194093990898483264387889840747,
            36519691378000053686808719375661435968736329760408643375056869728298445495677
        ];
        PoV.c_1 = 73375296327118824113819013486841075801169899181637920580621492268788381370603;

        // s=0 ballot
        vote.castBallot(1, pp, Z, PoV);

        uint64 s = 2; // two 1 ballots + three 0 ballots
        uint256[4] memory w = [
            24377100417841368779428648785521133982831968975092502424061349681002171620991,
            4077796762834673158323034097331602200483637878808238328480010541929097435188,
            88298994947563398605423655443178390217812384127938217083978236414757379816599,
            101029134881245189564267847070463473651301537654236983832022988928142147235595
        ];

        CicadaVote.ProofOfExponentiation memory PoE;
        PoE.pi = [
            5892276222152718978579309584087311486350314863110892479193978560142209406642,
            57943099565655858862289008016954573338488346145691069874542183455512227787609,
            77212122790674783557509235637868257973494300181331370103770786994717708979229,
            44887744040418924463005653730193203423244746976052280771909661329352656532445
        ];
        PoE.j = 109;
        PoE.l = 114297739051938986507376767718465427606631014087600825534715685279252968842727;        

        vm.warp(block.timestamp + 5 days);
        vote.finalizeVote(1, pp, s, w, PoE);        
    }

    function _getPublicParameters()
        private
        pure
        returns (CicadaVote.PublicParameters memory pp)
    {
        pp.N = [
            77396894314447592859859949539171496747276287100760693564222689465229532416249,
            54129994136396348060167372405535390836974371436092887839415021203245196516716,
            109360165825900780659167461960553307700334011965480444052936297521518669388937,
            112154645053370098513149601480265972045256985326333675226970359433305662707021
        ];
        pp.T = 63728;
        pp.g = [
            8311721277521670070237064744847866861259446163629451729970028114371968348322,
            83531393388209032183390224821807278370551772761140387105227584461640254925286,
            45642635725962699354815637308551437439086692255955029577154175345375171266647,
            71388388720623475838312861413943137990549630961318743316788974158396887677279
        ];
        pp.h = [
            22342359497179454571798417274106367197641315599601219256463688146367768099878,
            54334279483600389319361849584719680691871383433350666356742267305440066109104,
            81869980850889502112892571135428682043513414160614953954896580712759913133903,
            32863999335729276324265631317214229643131148383651948992379087326805661079432
        ];
        pp.y = [
            26166235907898018051173015173819713841522633205342876209928012801533656218438,
            50107929828071332996804188921695271585008959913967649474533495468854073561548,
            34652382988500071631670246795699202706698905333729709733134834815147955976386,
            94367177000149945240850067133570040273950513609289408770204611163717421465594
        ];
        pp.yInv = [
            23045403124378363143466629123866101038329714054891945246185128538426853826786,
            88419644540887267015160657047222479208170011379695098172525585728750244101404,
            50223859763708838008898571968828440190565708537179734425311459382690057508376,
            97029925466643368743150876741682232732975946397225743573044980087421268383632
        ];
    }
}