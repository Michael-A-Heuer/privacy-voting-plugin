pragma solidity ^0.8;

import 'forge-std/Test.sol';
import '../src/HomomorphicTimeLockVote.sol';
import '../src/LibUint1024.sol';


contract HomomorphicTimeLockVoteTest is Test {
    using LibUint1024 for *;

    HomomorphicTimeLockVote vote;

    function setUp() external {
        vote = new HomomorphicTimeLockVote();
        vote.createVote(_getPublicParameters(), "test", 0, 5 days);
    }

    function testEndToEnd()
        external
    {
        HomomorphicTimeLockVote.PublicParameters memory pp = _getPublicParameters();

        HomomorphicTimeLockVote.Puzzle memory Z;
        Z.u = [
            63512904068916075181495541114249893346292375585001845550786829225173540628421,
            48030633496487738534981058580506895953863786060743960629549258853171249414687,
            81705269054510484691340791712678152499676464426933816882364387613559130835284,
            59115056455504855570888548782282533633881114782046323365608735299661066402274
        ];
        Z.v = [
            11247755555480190098191942180655463316160599333098630620106354459443811038961,
            43750372348285677218505895554611876156271543103725136319795152268388949835968,
            85797564497615565111724163467261803597776957051256417070101892386663456896377,
            76652216763367501144588148917410613113237337597670286478933516799891807823173
        ];

        HomomorphicTimeLockVote.ProofOfValidity memory PoV;
        PoV.a_0 = [
            8898566250261096556924256145833555141856464476468935026206993241383178906410,
            11580450673096063324296210122962756695666528202362134555971869151325088147624,
            34714138160502969061915063588320069495624254373151495694447274327560752520342,
            63610101719144720169974535738866148119908803611709727379995305552662721699477
        ];
        PoV.b_0 = [
            88040318325653809300695319886389243617352730751231479852286148378340948315015,
            99190161107585169988780734450158931742154354201387680101583501357735219526321,
            9038695252312157972508136415146286185292354231288035555659779190796986938562,
            43317462039470707838984479742047850871508863853506321513243733337126649739335
        ];
        PoV.t_0 = [
            0,
            0,
            41169268275746632384601009525959897732055431464278613730373267527982022545415,
            47273073187920485757579355974014068513254865515274129047541784762709065382886
        ];
        PoV.c_0 = 52780866233676287400589217748494377034173555192079279860790823073708862814595;

        PoV.a_1 = [
            74978071166803796739705511064089364620023466311597405538495462963607732716169,
            91704828286066026777342445823095302164376978449770315258836996852443287267476,
            20268554138937675734799319015181818631568872751564497973712522286298016302445,
            48757768541366658178341975349821538467974540806012858499220267750203780559024
        ];
        PoV.b_1 = [
            32335570771333759826420621374684126579345400001255632573750215010815984486803,
            68064698522345063358751689309820044157203174955385899433462385367933412737011,
            109273382457334774854705513363932390175922447129293157595055273577716342816610,
            60267170926022738577689634393329770608372724514305857953282470662186243227940
        ];
        PoV.t_1 = [
            0,
            0,
            46184468601153897649841384297260798381119617291477568839403478778995545714491,
            88039002780988428092466205001201331916443335234410308599955705208832836643705
        ];
        PoV.c_1 = 59210580158573827332939516420220257682748320523453442000433702763751003788475;
        
        // 0 vote
        vote.castBallot(1, pp, Z, PoV);

        Z.u = [
            60198582862625786958148077559494380689661237985929527596570284178640937786350,
            29909913099691007705847486706841018897909197347535502121596728965480557030121,
            77360222025068594030436876747393153571797480540854927712504976932824038514745,
            23912990880766116708581005318942176582710136007248632985392081785425991406112
        ];
        Z.v = [
            76840448230891988675701875765795035694656343387892543859179288135989174685798,
            106254266863362176074291197690316580641594592201892007901463332928768963117334,
            34750720757069928678418647580004661573924197427989477955326874334701388429062,
            106205786266161038211015430253553576057333991082221441092372075845662205882247
        ];

        PoV.a_0 = [
            66438197708469486311695430840113670030824596550649689192282872966163044774562,
            103237638585649259241918653788143588136375634238466574986363084981728017504213,
            84147863217536721284234570533421467056284195853185010769663687176594083719881,
            53515773395464723800408118227510437254474358143424312082729570374465684647426
        ];
        PoV.b_0 = [
            67697960333717178923809535210280894100975262213602824380142599542748566127158,
            90321907330206488177063004050448170771006682483415480695983075348943452910758,
            106056701469199439562353505073131031656443649530085985590888503144249939468414,
            49306196478912749227962840548928921525861770394107263309535019850069167394805
        ];
        PoV.t_0 = [
            0,
            0,
            22653186299856331920812052737221446870802160327434294566551348583333089973534,
            37335790782996641494485563792376428130336199130162311792605190095986312865370
        ];
        PoV.c_0 = 36944959139446666902863957388786344285139790803302862164841103898436320070494;

        PoV.a_1 = [
            82447850564525106088455625620715406994569419455904995508641195194333361103649,
            57259261983892140259092915174027159173318769160032598459152664205625821379755,
            59148640870891285541008338283619771677535282705892869957300035032945031261991,
            12268090021704429517743571938421475095694422118392938773772532237657976229278
        ];
        PoV.b_1 = [
            38521813618865696019545179804068977408114371134536851561949437874499724755913,
            40017700408518468663328998806289915264172971918509648602422576615464583087245,
            86371497017825361239130587350758223299066047603400191559197506542667221397719,
            34048031658018220342849818345096527247754912987894994205139423581920211115919
        ];
        PoV.t_1 = [
            0,
            0,
            59616826040119758033949743224031863322416750713195561504917794384395822884578,
            59194167910778249646092963081491478918055788775707744838956054412110015626026
        ];
        PoV.c_1 = 97228759474321418854541559253265146496646367854920761413898674753985112875913;        

        // 1 vote
        vote.castBallot(1, pp, Z, PoV);

        Z.u = [
            19862080416486016390417170326819310990653845721383347511171340572884750765845,
            74876036313056492591484616002477366593996700865576345190262456962523543942479,
            44424271749429891189943454638086109585225780082823822370627610989832079578641,
            60941918665999014229170955291931758211117681607205597560027451425726049243156
        ];
        Z.v = [
            68396035938222018887239116281805875968035161691662211705259650096540135416434,
            47515011338043799328216518678361311706206891253691479255061986343583632297010,
            104292116136933149295681168371039165503539986332531424286457958718136356985239,
            89030393660605533134779932978195112115317533458010608934821284639262604013997
        ];

        PoV.a_0 = [
            84565449699766374703412381120987430363659119277399665018927788275110170699379,
            112992932155861081576899508878452757422364875796335441348522543852005575938438,
            95510356450232950694298000468502643944492476638098255218886258058392624750178,
            111833700255356874983451305082275926209409103759787635143828357777054542968928
        ];
        PoV.b_0 = [
            75731039510373902194615845534631379637346156959506474255900173089260572797095,
            48529767414849775118418823898981339714790061546837957886464731713611317222332,
            19066662906486288119749052230309893284672081658478187549832693828007707331470,
            77563943356925171289486282467991392500810744019849007346833090266726649549117
        ];
        PoV.t_0 = [
            0,
            0,
            65332632756204640597454593574182352566713573241750470480634280405234601342448,
            49085672708553952544199566861637439846062566145513116826157361211845882308612
        ];
        PoV.c_0 = 79182302164326753661170331600674609951174238341744530851664976864272047247997;

        PoV.a_1 = [
            86093264385864714340708080589951770670097230089507695910651460095777147703841,
            60046221404957118590652797666388738291511185272830730794421058046540247578680,
            73182180579068357949712861431669309759230309406491635932108916285198881552550,
            66355629758646313004777835918884945500341410262933769079468321798556981007837
        ];
        PoV.b_1 = [
            85121447569124522946080499214075170479615619285999039415675757691590806530759,
            31363864055836676076982468754842602725837452487061927922876183958829006676593,
            44960767632393342939579488158182287505576711582559941660758152979252025398784,
            7530495989036579483799984160718756958921583052265161219116814227826623309829
        ];
        PoV.t_1 = [
            0,
            0,
            584484103090843398848174733155458994938248155241755310194036828607564605838,
            67018461318398787583451358379156703254148934340456093641789068376746366108085
        ];
        PoV.c_1 = 708387139913466644473467808297404845906750267427404634742077565287526756000;        

        // 1 vote
        vote.castBallot(1, pp, Z, PoV);

        Z.u = [
            86190342303127716922744042209070255672313295459563935051491719855213670705094,
            4740388126700601524308243945239327513427021795886337149733558810564686231689,
            3155319086631174417619210302007373465664688049522427509811014986645123668691,
            94701626377337213647350067332816994222020336032202832288123784950115782930627
        ];
        Z.v = [
            10102396652656242373327760907396884422741735039045787886018801587360778009043,
            7411505978578159350315703877311124500802412168022199716567857956022682902791,
            29012329387139923239064085958536021408732715835611901463931999575750702668140,
            53425950317034793203954818422305231130454351809375679836899465193296704628381
        ];

        PoV.a_0 = [
            13279007779577321262709375000890917722581785258354406053453137320990717470725,
            64511731762504809097893726509442733948937705569861622487103161896302548615910,
            100985184509486891251318281756525856361967779864589250326684495554560320234830,
            95605922559855977626640056905465365543479927520087159336423118063684728445534
        ];
        PoV.b_0 = [
            15049529758310634169773533991211910551904567192760570809790362376101473563868,
            79925157247541133657244525346401589848422971631799883168028725954975446049336,
            76577827064814923232555179531123905486092257962482264617694213025448025638930,
            37160060838692402641275839198430253497726152497675099934434954221173194883273
        ];
        PoV.t_0 = [
            0,
            0,
            71603171494681951868271873358876306077387042593388777790733638650178842968365,
            18595425273178446891520262114276951069367390194142836340944451725867280198786
        ];
        PoV.c_0 = 109297145618602794005775615621204538400007976679622362102507781672577106762959;

        PoV.a_1 = [
            39388889563587793803142717416942231995650530136038660145506541655753658280665,
            53185110506594365250047906707095690207075425526997511961243731131753191007161,
            109218414667250809427319797184299900607278270734388960823875839561553857489935,
            2414315170516748021934784373904979873787600621474953055145027876386616091855
        ];
        PoV.b_1 = [
            80102691264112237892537920861014133067961241286398971384039626123383310955840,
            9802739040041000936036643677413308117485419517162142360003727924437229220489,
            102242860145387826724879446109803113429088212244321834948139683009208266104355,
            5244978388470644832983202917790258482776880084798121004384044886046592191821
        ];
        PoV.t_1 = [
            0,
            0,
            62047310934828975736243986819610029130345027478446290492421682629934468303394,
            18593696321817332383840609030861925959864141446963707700366034555533835763911
        ];
        PoV.c_1 = 94710804520584742997190033784826065213789643230371178561301982590658918060163;        

        // 0 vote
        vote.castBallot(1, pp, Z, PoV);

        Z.u = [
            54804204425733662745992949638962767106235700236577595398337261051367248657931,
            33645097667515086040837217917678748329294236767309175055053824327249428935831,
            63546684100238685106718031390862590351792562567163044494491604632753827768404,
            103583938916266427090999178116825398702797098897778813615128630936970144079903
        ];
        Z.v = [
            58731431050300422957285808760810210678570834414921154343932935573853855317848,
            7598215814474651625026750565849533023251828892854353720575690257964461366784,
            52673465667142608127570227774465344777223155722085537727704057009491451697653,
            112981431143927560504498852130713004831394617643176735070106577054417317016418
        ];

        PoV.a_0 = [
            36176382608173033572509203064273261202688708103116098249709462075619418455035,
            100368185324184615109254228223927810333602044052559258488657273282488412481847,
            26282920427483403032867493668479575770513133050072785648562353359959705175201,
            70826166080547109463986236794080905395052330678060538017017614966161081232449
        ];
        PoV.b_0 = [
            10801632128400592421321944497587613319410721433692262943788127897362829799791,
            77344311845712360313158459146828550589039372400822865250963715616228042343013,
            95651517873008467295406408206438645720410451403940913629694058850544570799164,
            44752811540145535344971796766560538094212638030198421532073199884047049343534
        ];
        PoV.t_0 = [
            0,
            0,
            3222076484113721340108797160850922884815876003191904291597103175134303454032,
            19168746360509049439773212447582423244379993081899217491779947703336784416255
        ];
        PoV.c_0 = 83807632169582425803402660213723104476774952523990871351231413717357621197574;

        PoV.a_1 = [
            89930212807958328368334389002058890695018245429652054827046491160337083170609,
            104577314713535560167999038924259136620220550050556075423949545838697720433796,
            1569608580063391264050595198891620991378711861271462117403846988316514868681,
            8522939098188351817118930493653722497586869412609580299636518400949194819077
        ];
        PoV.b_1 = [
            43010306015861081000046072697318415832354777063301672335595634744532047016221,
            72502430167316831221529099296230211193357799088697753028197443498684356414069,
            992010620646780875510328664848805958298921932131031048923889660110757294277,
            54478111085367574279769202111307440030698945757485236510976752896488235847701
        ];
        PoV.t_1 = [
            0,
            0,
            3373479035174943095042564303635976132395504347898570943319579514889052657322,
            57351097977793679815683957124907726606016261353554813312633023261788965269983
        ];
        PoV.c_1 = 87745679379645939051627816081539873109998604416928796766316954222277830821462;    

        // 1 vote
        vote.castBallot(1, pp, Z, PoV);

        (, HomomorphicTimeLockVote.Puzzle memory tally,,,) = vote.votes(1);

        uint256 s = 3; // three 1 votes + two 0 votes
        uint256[4] memory w = [
            82111881153032964502712872703680535698283608980465203047999708554703939257369,
            28393139427949041430732717799339033925151693518936412740197800384866329064974,
            70187927336251351277061654691675862793674096274051309338396518880678334234759,
            7761532675575422141823937129367552553361766496084480824430555349180621290470
        ];

        HomomorphicTimeLockVote.ProofOfExponentiation memory PoE;
        PoE.pi = [
            64237733900192627029939021078635243017016247487953958079550278933721813238537,
            68684110474354858416982204888227704320260447967257726194511335961443956748666,
            29287386708015882683613815601053520691299194954476928036256287940686862936784,
            108116927585871102526066836913106112683535574595455034489803227008536991473229
        ];
        PoE.j = 15;
        PoE.l = 72150443041924549490593583023029954425070906154691050651390610991695567473049;

        vote.verifySolutionCorrectness(pp, tally, s, w, PoE);        
    }

    function _getPublicParameters()
        private
        pure
        returns (HomomorphicTimeLockVote.PublicParameters memory pp)
    {
        pp.N = [
            90174667221454489999708335293638888921383294503261016775082315586019129247538,
            27783000991923127285442956467246066471070549324469944224990320185588872816327,
            17723186519587454345853945675646933173517954070308933169719621357713908555936,
            41717917969786729150704526033058118901136022684846215382399316127957620346933
        ];
        pp.T = 54278;
        pp.g = [
            32071096626711938632248129947394041736764166608472930883293931101379032340342,
            59023395575443449291871474678873111088184850255268657556835496893368882084399,
            73535449040266682378544448114093513576776229417769217580991626784659845103448,
            71530346901895682076587330424479411739920471302274322933980369758527761505455
        ];
        pp.h = [
            17220723195001111711829176835702230371934183077784474070494415636834146251876,
            73353170373977352292558112098528262151983701100091596738866445979912956344301,
            62088207710416498341733132856511377767800486120721658881803431664682493253560,
            28821057511726341651808512341421753406698894419384273383528018149255961759176
        ];
        pp.y = [
            72752113236960465826455240756984472153650127590167968078859189694520341365161,
            62096458050354421098944604278628715465146880264334032622767408041664291884071,
            15289105727777576801067294063869918556848633574115291136523426787846361753244,
            90578865377770181373897665562226014887507894192817745954068074591053690377203
        ];
        pp.yInv = [
            22551407868738340044604413371055289194192861785771795060891816317758964363998,
            106722324085321332349384813877015340639383384883726434534344727051713557623063,
            70002846402377378448502888531909698494864421274445614624624545425778403799066,
            39564171945903880050939770949054549170710186649453570815069383960634659583933
        ];        
    }
}